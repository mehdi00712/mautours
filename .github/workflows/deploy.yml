name: Deploy Firebase Hosting + Functions

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.html"
      - "css/**"
      - "assets/**"
      - "js/**"
      - "firebase.json"
      - ".github/workflows/deploy.yml"

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    # ‚úÖ Expose secrets as env so we can safely use them in `if:` checks
    env:
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      ABSA_URL:            ${{ secrets.ABSA_URL }}
      ABSA_MERCHANT_ID:    ${{ secrets.ABSA_MERCHANT_ID }}
      ABSA_SECRET:         ${{ secrets.ABSA_SECRET }}
      ABSA_AMOUNT_MODE:    ${{ secrets.ABSA_AMOUNT_MODE }}
      ABSA_MOCK:           ${{ secrets.ABSA_MOCK }}

    steps:
      - name: üßæ Checkout repo
        uses: actions/checkout@v4

      - name: üîê Google auth (service account JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_MAUTOURS_60318 }}

      - name: üü¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: üì¶ Install Firebase CLI
        run: npm i -g firebase-tools

      # ‚úÖ Only run if ABSA_URL env is present (works even if secret is missing)
      - name: ‚öôÔ∏è Set Functions Config (ABSA)
        if: ${{ env.ABSA_URL != '' }}
        run: |
          firebase functions:config:set \
            absa.url="${ABSA_URL}" \
            absa.merchant_id="${ABSA_MERCHANT_ID}" \
            absa.secret="${ABSA_SECRET}" \
            absa.amount_mode="${ABSA_AMOUNT_MODE}" \
            absa.mock="${ABSA_MOCK}" \
            --project "${FIREBASE_PROJECT_ID}"

      - name: üìÅ Install Functions deps
        working-directory: js/functions
        run: npm ci

      - name: üöÄ Deploy Functions
        run: firebase deploy --only functions --project "${FIREBASE_PROJECT_ID}"

      - name: üåê Deploy Hosting
        run: firebase deploy --only hosting --project "${FIREBASE_PROJECT_ID}"
